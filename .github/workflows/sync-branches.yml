name: Sync Version Branches (Flattened)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync All Versions
        run: |
          VERSIONS=("1.20.1" "1.20.4" "1.20.6" "1.21.1" "1.21.3" "1.21.4" "1.21.5" "1.21.6" "1.21.8" "1.21.10" "1.21.11")
          
          for VER in "${VERSIONS[@]}"; do
            echo "Processing version $VER..."
            
            # 1. Create temporary directory
            TEMP_DIR="temp_sync_$VER"
            mkdir -p $TEMP_DIR
            
            # 2. Copy root files (gradlew, wrapper, .gitignore, LICENSE, README)
            cp -r gradle gradlew gradlew.bat .gitignore LICENSE README.md gradle.properties settings.gradle $TEMP_DIR/
            
            # 3. Copy version-specific files (build.gradle and mod-specific src)
            # In your case, build.gradle in root refers to subprojects. 
            # We need to adapt it slightly for a single project.
            cp $VER/build.gradle $TEMP_DIR/build.gradle
            
            # 4. Merge src (Common + Version Specific)
            mkdir -p $TEMP_DIR/src
            if [ -d "common/src" ]; then cp -r common/src/* $TEMP_DIR/src/; fi
            if [ -d "$VER/src" ]; then cp -r $VER/src/* $TEMP_DIR/src/; fi
            
            # 5. Fix build.gradle paths (removing subproject references if any)
            # (In this project, version-specific build.gradle is already mostly standalone)
            
            # 6. Push to branch
            cd $TEMP_DIR
            git init
            git add .
            git commit -m "Auto-sync $VER from main"
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push origin HEAD:refs/heads/ver/$VER --force
            cd ..
            rm -rf $TEMP_DIR
          done
